# Case-study оптимизации

## Актуальная проблема
В нашем проекте возникла серьёзная проблема.

Необходимо было обработать файл с данными, чуть больше ста мегабайт.

У нас уже была программа на `ruby`, которая умела делать нужную обработку.

Она успешно работала на файлах размером пару мегабайт, но для большого файла она работала слишком долго, и не было понятно, закончит ли она вообще работу за какое-то разумное время.

Я решил исправить эту проблему, оптимизировав эту программу.

## Формирование метрики
Для того, чтобы понимать, дают ли мои изменения положительный эффект на быстродействие программы я придумал использовать такую метрику: оперативная память

## Гарантия корректности работы оптимизированной программы
Программа поставлялась с тестом. Выполнение этого теста в фидбек-лупе позволяет не допустить изменения логики программы при оптимизации.

## Feedback-Loop
Для того, чтобы иметь возможность быстро проверять гипотезы я выстроил эффективный `feedback-loop`, который позволил мне получать обратную связь по эффективности сделанных изменений за 15 секунд

Вот как я построил `feedback_loop`: 
- замер потребляемой памяти профилировщиком
- выяснение точки роста
- поиск возможности оптимизации точки роста
- при возможности, оптимизация точки роста

## Вникаем в детали системы, чтобы найти главные точки роста
Для того, чтобы найти "точки роста" для оптимизации я воспользовался 
- gem 'memory_profiler'
- gem 'ruby-prof'
- gem 'stackprof'

Вот какие проблемы удалось найти и решить

### Ваша находка №1
- memory_profiler показал точку роста в загрузке всего файла
- переделать программу на построчное считывание
- изначально при чтении файла из 10000 строк потреблялось 441.91 MB, после изменения программы на построчное считывание стало 16.47 MB
- изменилась главна точка роста

### Ваша находка №2
- stackprof показал точку роста в split(',')
- убрал лишние split(','), оставил только в одном месте
- кол-во аллокаций уменьшилось с 93104 до 67712
- кол-во потребляемой памяти уменьшилось с 16.47 MB до 13.09 MB
- пробовал заменить (',') на регулярное выражение, но память увеличиласть на 1 мб
- точка роста осталась там же

### Ваша находка №X
- какой отчёт показал главную точку роста
- как вы решили её оптимизировать
- как изменилась метрика
- как изменился отчёт профилировщика

## Результаты
В результате проделанной оптимизации наконец удалось обработать файл с данными.
Удалось улучшить метрику системы с *того, что у вас было в начале, до того, что получилось в конце* и уложиться в заданный бюджет.

*Какими ещё результами можете поделиться*

## Защита от регрессии производительности
Для защиты от потери достигнутого прогресса при дальнейших изменениях программы *о performance-тестах, которые вы написали*
